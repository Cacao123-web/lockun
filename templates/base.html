{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Libra Health – Quản lý sức khỏe{% endblock %}</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Favicon + custom CSS -->
  <link rel="icon" href="{% static 'img/favicon.png' %}">
  <link rel="stylesheet" href="{% static 'css/health.css' %}">
</head>

<body>

  <!-- Topbar -->
  <div class="topbar py-1 text-white">
    <div class="container d-flex justify-content-between small">
      <div><i class="bi bi-envelope"></i> librahealth@gmail.com</div>
      <div><i class="bi bi-globe2"></i> Chăm sóc tận tâm – Sức khỏe vẹn toàn</div>
    </div>
  </div>

  <!-- Header -->
  <header class="header py-3">
    <div class="container d-flex align-items-center gap-3 flex-wrap">
      <a class="logo d-flex align-items-center text-decoration-none" href="{% url 'dashboard' %}">
        <img src="{% static 'img/logo.png' %}" alt="Libra Health" height="44" class="me-2">
        <strong class="brand">Libra Health</strong>
      </a>

      <form class="ms-auto me-3 searchbar d-flex" method="get" action="/search/">
        <input name="q" class="form-control" placeholder="Tìm kiếm…" aria-label="Tìm kiếm">
        <button class="btn btn-green ms-2"><i class="bi bi-search"></i></button>
      </form>

      <div class="hotline text-green fw-bold">
        <i class="bi bi-telephone-outbound-fill me-2"></i>090.123.443
      </div>
    </div>
  </header>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark nav-green">
    <div class="container">

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainnav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div id="mainnav" class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="{% url 'dashboard' %}">Trang chủ</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'about' %}">Giới thiệu</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'services' %}">Dịch vụ</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'health_overview' %}">Sức khỏe cá nhân</a></li>
          <li class="nav-item"><a class="nav-link" href="/tracker/workouts/">Tập luyện</a></li>
          <li class="nav-item"><a class="nav-link" href="/tracker/meals/">Dinh dưỡng</a></li>
          <li class="nav-item"><a class="nav-link" href="/goals/">Mục tiêu</a></li>
          <li class="nav-item"><a class="nav-link" href="/reports/">Báo cáo</a></li>

          {% if user.is_staff %}
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:admin_users' %}">Quản trị Users</a></li>
          {% endif %}
        </ul>

        <!-- LOGIN / LOGOUT (ĐÃ FIX KHÔNG NHẢY) -->
        <ul class="navbar-nav">
          {% if user.is_authenticated %}

          <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:profile' %}">
              <i class="bi bi-person-circle"></i> Hồ sơ
            </a>
          </li>

          <!-- Logout link + hidden POST form -->
          <li class="nav-item">
            <a class="nav-link" href="#"
               onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
              <i class="bi bi-box-arrow-right"></i> Đăng xuất
            </a>
          </li>

          <form id="logout-form"
                method="post"
                action="{% url 'accounts:logout' %}"
                style="display:none;">
            {% csrf_token %}
          </form>

          {% else %}
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:login' %}">Đăng nhập</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:signup' %}">Đăng ký</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <div class="container">
      {% block hero %}{% endblock %}
    </div>
  </section>

  <!-- Main -->
  <main class="py-4">
    <div class="container">

      {% if messages %}
        {% for m in messages %}
          <div class="alert alert-{{ m.tags }}">{{ m }}</div>
        {% endfor %}
      {% endif %}

      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer py-4 text-white">
    <div class="container">
      <div class="fw-bold mb-2">Libra Health</div>
      <div>Địa chỉ: 123 Đường Lý Thái Tổ, Q.1, TP.HCM</div>
      <div>Hotline: 0907 5962536</div>
      <div>Email: librahealth@gmail.com</div>
    </div>
  </footer>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ================= CHAT AI (giữ nguyên của bạn) ================= -->
  <style>
    .ai-chat-fab {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #6d5dfc, #8b5cf6);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 8px 25px rgba(0,0,0,.3);
      cursor: pointer;
      z-index: 9999;
    }

    .ai-chat-panel {
      position: fixed;
      right: 20px;
      bottom: 90px;
      width: 360px;
      height: 430px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 9998;
    }

    .ai-chat-header {
      background: #000;
      color: #fff;
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    .ai-chat-messages {
      flex: 1;
      padding: 10px;
      background: #f3f4f6;
      overflow-y: auto;
    }

    .ai-msg-user {
      background: #4f46e5;
      color: #fff;
      padding: 8px 12px;
      border-radius: 14px;
      margin-left: auto;
      margin-bottom: 8px;
      max-width: 80%;
    }

    .ai-msg-bot {
      background: #e5e7eb;
      padding: 8px 12px;
      border-radius: 14px;
      margin-right: auto;
      margin-bottom: 8px;
      max-width: 80%;
    }

    .ai-chat-input-row {
      display: flex;
      padding: 8px;
      gap: 6px;
      border-top: 1px solid #ddd;
    }

    .ai-chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #ccc;
      padding: 8px 12px;
    }

    .ai-chat-send-btn {
      background: #22c55e;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
  </style>

  <div id="ai-fab" class="ai-chat-fab">AI</div>

  <div id="ai-panel" class="ai-chat-panel">
    <div class="ai-chat-header">
      Trợ lý sức khỏe
      <button id="ai-close" style="color:#fff;background:none;border:none;font-size:20px;cursor:pointer;">×</button>
    </div>

    <div id="ai-msgs" class="ai-chat-messages"></div>

    <form id="ai-form" class="ai-chat-input-row">
      <input id="ai-input" class="ai-chat-input" placeholder="Hỏi về BMI, TDEE, mục tiêu..." autocomplete="off">
      <button type="submit" class="ai-chat-send-btn">Gửi</button>
    </form>
  </div>

  <script>
    const fab = document.getElementById("ai-fab");
    const panel = document.getElementById("ai-panel");
    const closeBtn = document.getElementById("ai-close");
    const form = document.getElementById("ai-form");
    const input = document.getElementById("ai-input");
    const msgs = document.getElementById("ai-msgs");

    fab.onclick = () => panel.style.display = "flex";
    closeBtn.onclick = () => panel.style.display = "none";

    function addMsg(txt, who) {
      const div = document.createElement("div");
      div.className = who === "user" ? "ai-msg-user" : "ai-msg-bot";
      div.textContent = txt;
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      addMsg(text, "user");
      input.value = "";

      try {
        const res = await fetch("/api/chat/", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({message: text})
        });
        const data = await res.json();
        addMsg(data.reply || "Mình chưa rõ, bạn thử hỏi lại nhé!", "bot");
      } catch {
        addMsg("Máy chủ AI không phản hồi. Hãy đảm bảo Ollama đang chạy.", "bot");
      }
    };
  </script>

</body>
</html>
